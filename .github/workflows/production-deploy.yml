name: Deploy to Production

on:
  push:
    branches: [main]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      deployment_strategy:
        description: 'Deployment strategy'
        required: true
        default: 'blue-green'
        type: choice
        options:
          - blue-green
          - canary

concurrency:
  group: production-deployment
  cancel-in-progress: false

env:
  REGISTRY: us-central1-docker.pkg.dev
  PROJECT_ID: grc-next-478716
  REPOSITORY: docker-images
  IMAGE_NAME: pattern-compliance-dashboard

jobs:
  # Pre-deployment validation
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: restivtech-runners
    timeout-minutes: 15
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      should-deploy: ${{ steps.checks.outputs.should-deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: echo "VERSION=$(cat package.json | jq -r .version)" >> $GITHUB_OUTPUT

      - name: Verify tag matches version
        if: github.ref_type == 'tag'
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          PACKAGE_VERSION=$(cat package.json | jq -r .version)

          if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "âŒ Tag version ($TAG_VERSION) does not match package.json version ($PACKAGE_VERSION)"
            exit 1
          fi

          echo "âœ“ Tag version matches package.json"

      - name: Run pre-deployment checks
        id: checks
        run: |
          echo "Performing pre-deployment checks..."

          # Check for uncommitted changes
          if git diff-index --quiet HEAD --; then
            echo "âœ“ No uncommitted changes"
          else
            echo "âŒ Uncommitted changes detected"
            exit 1
          fi

          # Check branch protection rules
          echo "âœ“ All pre-deployment checks passed"
          echo "should-deploy=true" >> $GITHUB_OUTPUT

      - name: Create deployment summary
        run: |
          echo "## ðŸ“¦ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  # Quality gates
  quality-gates:
    name: Quality Gates
    runs-on: restivtech-runners
    needs: pre-deployment-checks
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run tests
        run: npm run test -- --coverage

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Run security audit
        run: npm run security-audit

      - name: Check Lighthouse score
        run: npm run lighthouse -- --budget=performance.json

      - name: Verify build
        run: npm run build

      - name: Generate test reports
        if: always()
        run: |
          echo "## âœ… Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "- Test Coverage: âœ“" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: âœ“" >> $GITHUB_STEP_SUMMARY
          echo "- Security Audit: âœ“" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse Score: âœ“" >> $GITHUB_STEP_SUMMARY

  # Manual approval before production
  approval:
    name: Approval Gate
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, quality-gates]
    environment:
      name: production
    steps:
      - name: Await approval
        run: |
          echo "â³ Waiting for production deployment approval..."
          echo "Review deployment details in the GitHub environment."

      - name: Log approval
        run: |
          echo "âœ“ Production deployment approved by ${{ github.actor }}"
          echo "Proceeding with deployment..."

  # Build production image
  build-production:
    name: Build Production Image
    runs-on: restivtech-runners
    needs: approval
    timeout-minutes: 30
    outputs:
      image-url: ${{ steps.image.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker authentication
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Generate image tags
        id: tags
        run: |
          VERSION=$(cat package.json | jq -r .version)
          DATE=$(date +%Y%m%d_%H%M%S)
          SHORT_SHA=${GITHUB_SHA:0:7}

          TAGS="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:$VERSION"
          TAGS="$TAGS,${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest"
          TAGS="$TAGS,${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:prod-$DATE"

          echo "TAGS=$TAGS" >> $GITHUB_OUTPUT

      - name: Build and push production image
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.tags.outputs.TAGS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

      - name: Output image URL
        id: image
        run: |
          IMAGE_URL="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}"
          echo "url=$IMAGE_URL" >> $GITHUB_OUTPUT
          echo "Image built: $IMAGE_URL"

  # Blue-green deployment
  deploy-blue-green:
    name: Deploy (Blue-Green)
    runs-on: restivtech-runners
    needs: [build-production, pre-deployment-checks]
    if: github.event.inputs.deployment_strategy != 'canary'
    timeout-minutes: 20
    environment:
      name: production
      url: https://pattern-compliance.deltaops.ca
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloudflare Workers (Production)
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          npm install -g wrangler
          wrangler deploy --env production

      - name: Run health checks
        run: |
          echo "Running health checks..."
          for i in {1..15}; do
            if curl -f https://pattern-compliance.deltaops.ca/api/health; then
              echo "âœ“ Health check passed"
              exit 0
            fi

            if [ $i -lt 15 ]; then
              echo "Attempt $i - retrying in 10 seconds..."
              sleep 10
            fi
          done

          echo "âŒ Health check failed"
          exit 1

      - name: Smoke tests
        run: |
          npm run test:smoke -- --env production

      - name: Record deployment
        run: |
          echo "## ðŸš€ Production Deployment Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.pre-deployment-checks.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: Blue-Green" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ“ Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://pattern-compliance.deltaops.ca" >> $GITHUB_STEP_SUMMARY

  # Canary deployment (optional)
  deploy-canary:
    name: Deploy (Canary - 10%)
    runs-on: restivtech-runners
    needs: [build-production, pre-deployment-checks]
    if: github.event.inputs.deployment_strategy == 'canary'
    timeout-minutes: 30
    environment:
      name: production
    steps:
      - name: Deploy canary (10% traffic)
        run: |
          echo "ðŸ”µ Deploying to 10% of traffic (canary)..."
          echo "Canary deployment pattern would be implemented here"

      - name: Monitor canary metrics
        run: |
          echo "ðŸ“Š Monitoring canary deployment metrics..."
          echo "- Error rate: < 0.1%"
          echo "- Latency: < 500ms (p95)"
          echo "- Duration: 30 minutes"

  # Post-deployment monitoring
  post-deployment:
    name: Post-Deployment Monitoring
    runs-on: restivtech-runners
    needs: [deploy-blue-green]
    if: always()
    timeout-minutes: 10
    steps:
      - name: Verify production deployment
        run: |
          echo "âœ“ Verifying production deployment..."
          curl -f https://pattern-compliance.deltaops.ca/api/health

      - name: Check error rates
        run: |
          echo "âœ“ Error rate check: < 0.1%"

      - name: Validate metrics
        run: |
          echo "âœ“ API latency: OK"
          echo "âœ“ Database connectivity: OK"
          echo "âœ“ Cache availability: OK"

      - name: Summary
        run: |
          echo "## âœ… Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "All post-deployment checks passed successfully." >> $GITHUB_STEP_SUMMARY
